<!DOCTYPE html>
<html>
    <head>
        <title>Nephilim Savage Worlds edition Character Manager</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>
    <body>
        <div id="log"></div>

        <script src="./js/riot+compiler.min.js"></script>
        <script src="./js/pdf/pdfmake.min.js"></script>
        <script src="./js/pdf/vfs_fonts.js"></script>
        <script src="./js/Character.js"></script>
        <script src="./js/Model.js"></script>
        <script>

            var model = new Model()

            function toDataUrl(url) {
                return new Promise(function (fulfill, reject) {
                    var xhr = new XMLHttpRequest()
                    xhr.responseType = 'blob'
                    xhr.onload = function (e) {
                        if (e.target.status === 200) {
                            var reader = new FileReader()
                            reader.onloadend = function (e) {
                                fulfill(e.target.result)
                            }
                            reader.readAsDataURL(xhr.response)
                        } else {
                            reject(e)
                        }
                    }
                    xhr.open('GET', url)
                    xhr.send()
                })
            }

            var loading = []
            for (var idx in model.kaList) {
                var ka = model.kaList[idx]
                loading.push(toDataUrl('./img/' + ka + '.png'))
            }

            Promise.all(loading)
                    .then(function (kaImg) {

                        var docDefinition = {
                            content: [
                                {
                                    table: {
                                        body: [
                                            [
                                                '',
                                                {
                                                    image: kaImg[0],
                                                    fit: [30, 30]
                                                },
                                                {text: 'd10', alignment: 'left', style: 'verticalAlign'},
                                                ''
                                            ],
                                            [
                                                {text: "+1", alignment: 'right', style: 'verticalAlign'},
                                                {
                                                    image: kaImg[1],
                                                    fit: [30, 30]
                                                },
                                                {
                                                    image: kaImg[2],
                                                    fit: [30, 30]
                                                },
                                                {text: "+2", alignment: 'left', style: 'verticalAlign'}
                                            ],
                                            [
                                                {text: "+3", alignment: 'right', style: 'verticalAlign'},
                                                {
                                                    image: kaImg[3],
                                                    fit: [30, 30]
                                                },
                                                {
                                                    image: kaImg[4],
                                                    fit: [30, 30]
                                                },
                                                {text: "+4", alignment: 'left', style: 'verticalAlign'}
                                            ]
                                        ]
                                    },
                                    layout: 'noBorders'
                                }
                            ],
                            styles: {
                                verticalAlign: {
                                    margin: [0, 6, 0, 0]
                                }
                            }
                        }
                        pdfMake.createPdf(docDefinition).open()

                    })
                    .catch(function (e) {
                        console.error(e.target.status)
                    })


        </script>
    </body>
</html>
