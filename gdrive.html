<!DOCTYPE html>
<html>
    <head>
        <title>Nephilim Savage Worlds edition Character Manager</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>
    <body>

        <p>Drive API Quickstart</p>

        <!--Add buttons to initiate auth sequence and sign out-->
        <button id="authorize-button" style="display: none;">Authorize</button>
        <button id="signout-button" style="display: none;">Sign Out</button>

        <pre id="content"></pre>

        <script type="text/javascript">
            const boundary = '-------314159265358979323846264';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";
                    // Client ID and API key from the Developer Console
                    var CLIENT_ID = '374977961173-o1qsjjbj0tnbb0smjdanpmvsraoshd8q.apps.googleusercontent.com';
            // Array of API discovery doc URLs for APIs used by the quickstart
            var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
            // Authorization scopes required by the API; multiple scopes can be
            // included, separated by spaces.
            var SCOPES = 'https://www.googleapis.com/auth/drive';
            var authorizeButton = document.getElementById('authorize-button');
            var signoutButton = document.getElementById('signout-button');
            /**
             *  On load, called to load the auth2 library and API client library.
             */
            function handleClientLoad() {
                gapi.load('client:auth2', initClient);
            }

            /**
             *  Initializes the API client library and sets up sign-in state
             *  listeners.
             */
            function initClient() {
                gapi.client.init({
                    discoveryDocs: DISCOVERY_DOCS,
                    clientId: CLIENT_ID,
                    scope: SCOPES
                }).then(function () {
                    // Listen for sign-in state changes.
                    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                    // Handle the initial sign-in state.
                    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                });
            }

            function uploadFile(fileName, contentType, content, fileId) {
                var metadata = {
                    'title': fileName,
                    'mimeType': contentType
                };
                var base64Data = btoa(content);
                var multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: ' + contentType + '\r\n' +
                        'Content-Transfer-Encoding: base64\r\n' +
                        '\r\n' +
                        base64Data +
                        close_delim;
                var request = gapi.client.request({
                    'path': '/upload/drive/v2/files' + ((fileId === undefined) ? '' : '/' + fileId),
                    'method': (fileId === undefined) ? 'POST' : 'PUT',
                    'params': {'uploadType': 'multipart'},
                    'headers': {
                        'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
                    },
                    'body': multipartRequestBody
                });
                request.execute(function (arg) {
                    console.log(arg);
                });
            }

            function insertFile(fileName, contentType, content) {
                uploadFile(fileName, contentType, content)
            }

            function insertJson(filename, content) {
                insertFile(filename, 'application/json', JSON.stringify(content))
            }

            /**
             *  Called when the signed in status changes, to update the UI
             *  appropriately. After a sign-in, the API is called.
             */
            function updateSigninStatus(isSignedIn) {
                if (isSignedIn) {
                    listFiles();

                    var appState = {
                        number: 12,
                        text: 'hello'
                    };
                    insertJson('dump.json', appState)

                } else {
                    gapi.auth2.getAuthInstance().signIn();
                }
            }

            /**
             * Append a pre element to the body containing the given message
             * as its text node. Used to display the results of the API call.
             *
             * @param {string} message Text to be placed in pre element.
             */
            function appendPre(message) {
                var pre = document.getElementById('content');
                var textContent = document.createTextNode(message + '\n');
                pre.appendChild(textContent);
            }


            function getFirstIdByFilename(name) {
                return new Promise(function (fulfill, reject) {
                    gapi.client.drive.files.list({
                        'pageSize': 10,
                        'fields': "nextPageToken, files(id, name)",
                        q: "name='" + name + "'"
                    }).then(function (response) {
                        var files = response.result.files;
                        if (files && files.length > 0) {
                            fulfill(files[0].id);
                        } else {
                            reject('No files found.');
                        }
                    });
                });
            }

            /**
             * Print files.
             */
            function listFiles() {
                gapi.client.drive.files.list({
                    'pageSize': 10,
                    'fields': "nextPageToken, files(id, name)",
                    q: "name='dump.json'"
                }).then(function (response) {
                    appendPre('Files:');
                    var files = response.result.files;
                    if (files && files.length > 0) {
                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                            appendPre(file.name + ' (' + file.id + ')');
                        }
                    } else {
                        appendPre('No files found.');
                    }
                });
            }

        </script>

        <script async defer src="https://apis.google.com/js/api.js"
                onload="this.onload = function () {
                };
                handleClientLoad()"
                onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>

    </body>
</html>
